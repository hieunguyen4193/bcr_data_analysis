---
title: "VDJ data analysis on integrated dataset, Quantile: `r params$chosen.quantile`, Integration: `r params$integration.case`"
author:
  - "trnguyen@ukaachen.de"
date: "Last update on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: no
    df_print: paged
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 3
    number_sections: true
    theme: lumen
params:
  outdir: NA
  PROJECT: NA
  config.version: NA
  output.version: NA
  chosen.quantile: NA
  integration.case: NA
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

<style type="text/css">
    div.datatables { height: auto !important;}
</style>

```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.width=14, fig.height=10}
#####----------------------------------------------------------------------#####
#
# trnguyen@ukaachen.de
#
#####----------------------------------------------------------------------#####
# gc()
# rm(list = ls())

scrna_pipeline_src <- "/media/hieunguyen/HNSD01/src/src_pipeline/scRNA_GEX_pipeline/processes_src"
source(file.path(scrna_pipeline_src, "import_libraries.R"))
source(file.path(scrna_pipeline_src, "helper_functions.R"))
source(file.path(scrna_pipeline_src, "s8_integration_and_clustering.R"))

path.to.project.src <- "/media/hieunguyen/HNSD01/src/bcr_data_analysis/240805_data_analysis"
source(file.path(path.to.project.src, "config.R"))
#####----------------------------------------------------------------------#####
# CONFIGURATIONS 
#####----------------------------------------------------------------------#####
analysis.round <- "1st"
chosen.seed <- 42
num.dim.integration <- 25 
num.PCA <- 25
num.dim.cluster <- 25
num.PC.used.in.Clustering <- 25
num.PC.used.in.UMAP <- 25
my_random_seed <- 42


all.samples <- c("M1", "M2", "M3", "P1", "P2", "P3")
all.quantiles <- c(0.99, 0.95, 0.90, 0.85)
all.integration.case <- list(
  all_samples = all.samples,
  mouse1 = c("M1", "P1"),
  mouse2 = c("M2", "P2"),
  mouse3 = c("M3", "P3")
)

#####----------------------------------------------------------------------#####
##### input arguments
#####----------------------------------------------------------------------#####

# outdir <- "/home/hieunguyen/CRC1382/outdir"
outdir <- "/media/hieunguyen/HNSD01/outdir"
PROJECT <- "240805_BSimons"
output.version <- "20240820"
config.version <- "default"
chosen.quantile <- 0.85
integration.case <- "mouse2"

# outdir <- params$outdir
# PROJECT <- params$PROJECT
# output.version <- params$output.version
# config.version <- params$config.version
# chosen.quantile <- params$chosen.quantile
# integration.case <- params$integration.case

path.to.main.input <- file.path(outdir, PROJECT, output.version, config.version)
path.to.main.output <- file.path(outdir, PROJECT, "data_analysis", output.version, config.version)

path.to.01.output <- file.path(path.to.main.output, "01_output")
path.to.04.output <- file.path(path.to.main.output, "04_output", sprintf("quantile_%s", chosen.quantile))
path.to.05.output <- file.path(path.to.main.output, "05_output", sprintf("quantile_%s", chosen.quantile), integration.case)
path.to.06.output <- file.path(path.to.main.output, "06_output", sprintf("quantile_%s", chosen.quantile), integration.case)
dir.create(path.to.06.output, showWarnings = FALSE, recursive = TRUE)

path.to.input.s.obj <- file.path(path.to.04.output, integration.case, "s8_output", sprintf("%s.output.s8.rds", PROJECT))
s.obj <- readRDS(path.to.input.s.obj)

#####----------------------------------------------------------------------#####
##### pre-processing the data with ibex
#####----------------------------------------------------------------------#####
library("scRepertoire")
library("Ibex")

threshold <- 0.85
removeNA <- TRUE
removeMulti <- TRUE
if (file.exists(file.path(path.to.06.output, sprintf("combined_contigs_%s_%s_%s.rds", threshold, removeNA, removeMulti))) == FALSE){
  path.to.storage <- "/media/hieunguyen/HNSD01/storage"
  path.to.main.input <- file.path(path.to.storage, PROJECT)
  
  path.to.VDJ.input <- file.path(path.to.main.input, "VDJ")
  
  all.contig.files <- Sys.glob(file.path(path.to.VDJ.input, "*/filtered_contig_annotations.csv"))
  
  sample.names <- unlist(lapply(lapply(all.contig.files, dirname), basename))
  
  names(all.contig.files) <- sample.names
  
  contig_list <- lapply(all.contig.files, vroom, show_col_type = FALSE)
  
  names(contig_list) <- sample.names
  combined.contigs <- combineBCR(contig_list,
                                   samples = sample.names,
                                   ID = sample.names,
                                   removeNA = removeNA,
                                   removeMulti = removeMulti,
                                   threshold = threshold)
  saveRDS(combined.contigs, file.path(path.to.06.output, sprintf("combined_contigs_%s_%s_%s.rds", threshold, removeNA, removeMulti)))
} else {
  combined.contigs <- readRDS(file.path(path.to.06.output, sprintf("combined_contigs_%s_%s_%s.rds", threshold, removeNA, removeMulti)))
}

if (file.exists(file.path(path.to.06.output, sprintf("%s.ibex.output.s8.rds", PROJECT))) == FALSE){
  ##### change the barcode
  for (i in names(combined.contigs)){
    tmpdf <- combined.contigs[[i]]
    sample.id <- unique(tmpdf$ID)
    tmpdf <- tmpdf %>% rowwise() %>%
      mutate(barcode = str_replace(barcode, sprintf("%s_%s", sample.id, sample.id), sample.id))
    combined.contigs[[i]] <- tmpdf
  }
  
  s.obj <- combineExpression(combined.contigs, s.obj, cloneCall="aa")
  
  #Subset only B cells (by contigs)
  s.obj$BCR.recoverd <- "No"
  s.obj$BCR.recoverd[!is.na(s.obj$CTaa)] <- "Yes"
  s.obj <- subset(s.obj, BCR.recoverd == "Yes")
  
  s.obj <- runIbex(s.obj, 
                       chains = "Heavy",
                       encoder.input = "KF", 
                       reduction.name = "ibex.KF")
  
  s.obj <- RunUMAP(s.obj, 
                   reduction = "ibex.KF",
                   dims = 1:30,
                   reduction.name = 'ibex.umap', 
                   reduction.key = 'ibexUMAP_')
  
  saveRDS(s.obj, file.path(path.to.06.output, sprintf("%s.ibex.output.s8.rds", PROJECT)))
} else {
  s.obj <- readRDS(file.path(path.to.06.output, sprintf("%s.ibex.output.s8.rds", PROJECT)))
}
```

# UMAP
## Cells with proper clone information and cells without proper clone information
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
# DimPlot(object = s.obj, cells.highlight = list("with.Clone" = with.clone.cells, "without.Clone" = without.clone.cells), label = TRUE, label.size = 8, reduction = "INTE_UMAP")
```

## UMAP: All cells in all samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, label = TRUE, label.size = 8, reduction = "INTE_UMAP", label.box = TRUE)
```

## UMAP: all cells, grouped by samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, label = TRUE, label.size = 8, reduction = "INTE_UMAP", label.box = TRUE, group.by = "name")
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, reduction = "ibex.umap", label = TRUE, label.box = TRUE, group.by = "seurat_clusters", pt.size = 2)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
all.available.ht <- list()
for (sample.id in unique(s.obj$name)){
  all.available.ht[[sample.id]] <- unique(subset(s.obj, name == sample.id)$HTO_classification)  %>% sort()
}

meta.data <- s.obj@meta.data
count.clones <- table(meta.data$CTstrict)

clonedf <- data.frame(CTstrict = unique(meta.data$CTstrict))
clonedf <- clonedf %>% rowwise() %>%
  mutate(count = count.clones[[CTstrict]]) %>% arrange(desc(count))

for (sample.id in unique(s.obj$name)){
  clonedf[[sample.id]] <- unlist(lapply(clonedf$CTstrict, function(x){
    nrow(subset(meta.data, meta.data$CTstrict == x & meta.data$name == sample.id))
  }))  
  for (ht in all.available.ht[[sample.id]]){
    clonedf[[sprintf("%s_%s", sample.id, ht)]] <- unlist(lapply(clonedf$CTstrict, function(x){
      nrow(subset(meta.data, meta.data$CTstrict == x & meta.data$name == sample.id &  meta.data$HTO_classification == ht))
    })) 
  }
}
writexl::write_xlsx(clonedf, file.path(path.to.06.output, sprintf("clone_Table_%s.xlsx", integration.case)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
clonedf %>% create_dt()
```


