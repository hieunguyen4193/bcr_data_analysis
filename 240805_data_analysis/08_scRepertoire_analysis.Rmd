---
title: "VDJ data analysis on integrated dataset, Quantile: `r params$chosen.quantile`, Integration: `r params$integration.case`"
author:
  - "trnguyen@ukaachen.de"
date: "Last update on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: no
    df_print: paged
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 3
    number_sections: true
    theme: lumen
params:
  outdir: NA
  PROJECT: NA
  config.version: NA
  output.version: NA
  chosen.quantile: NA
  integration.case: NA
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

<style type="text/css">
    div.datatables { height: auto !important;}
</style>

```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.width=14, fig.height=10}
#####----------------------------------------------------------------------#####
#
# trnguyen@ukaachen.de
#
#####----------------------------------------------------------------------#####
# gc()
# rm(list = ls())

##### install the legacy version v1 of scRepertoire package
# devtools::install_github("ncborcherding/scRepertoire@v1", upgrade = FALSE)
# install.packages("https://cran.r-project.org/src/contrib/Archive/Matrix/Matrix_1.5-4.tar.gz", type = "source", repos = NULL)
# install.packages("https://cran.r-project.org/src/contrib/Archive/ggplot2/ggplot2_3.4.4.tar.gz", type = "source", repos = NULL)

scrna_pipeline_src <- "/media/hieunguyen/HNSD01/src/src_pipeline/scRNA_GEX_pipeline/processes_src"
source(file.path(scrna_pipeline_src, "import_libraries.R"))
source(file.path(scrna_pipeline_src, "helper_functions.R"))
source(file.path(scrna_pipeline_src, "s8_integration_and_clustering.R"))

path.to.project.src <- "/media/hieunguyen/HNSD01/src/bcr_data_analysis/240805_data_analysis"
source(file.path(path.to.project.src, "config.R"))
#####----------------------------------------------------------------------#####
# CONFIGURATIONS 
#####----------------------------------------------------------------------#####
analysis.round <- "1st"
chosen.seed <- 42
num.dim.integration <- 25 
num.PCA <- 25
num.dim.cluster <- 25
num.PC.used.in.Clustering <- 25
num.PC.used.in.UMAP <- 25
my_random_seed <- 42


all.samples <- c("M1", "M2", "M3", "P1", "P2", "P3")
all.quantiles <- c(0.99, 0.95, 0.90, 0.85)
all.integration.case <- list(
  all_samples = all.samples,
  mouse1 = c("M1", "P1"),
  mouse2 = c("M2", "P2"),
  mouse3 = c("M3", "P3")
)

#####----------------------------------------------------------------------#####
##### input arguments
#####----------------------------------------------------------------------#####

# outdir <- "/home/hieunguyen/CRC1382/outdir"
outdir <- "/media/hieunguyen/HNSD01/outdir"
PROJECT <- "240805_BSimons"
output.version <- "20240820"
config.version <- "default"
chosen.quantile <- 0.85
integration.case <- "all_samples"

# outdir <- params$outdir
# PROJECT <- params$PROJECT
# output.version <- params$output.version
# config.version <- params$config.version
# chosen.quantile <- params$chosen.quantile
# integration.case <- params$integration.case

path.to.main.input <- file.path(outdir, PROJECT, output.version, config.version)
path.to.main.output <- file.path(outdir, PROJECT, "data_analysis", output.version, config.version)

path.to.01.output <- file.path(path.to.main.output, "01_output")
path.to.04.output <- file.path(path.to.main.output, "04_output", sprintf("quantile_%s", chosen.quantile))
path.to.05.output <- file.path(path.to.main.output, "05_output", sprintf("quantile_%s", chosen.quantile), integration.case)
path.to.08.output <- file.path(path.to.main.output, "06_output", sprintf("quantile_%s", chosen.quantile), integration.case)
dir.create(path.to.08.output, showWarnings = FALSE, recursive = TRUE)

path.to.input.s.obj <- file.path(path.to.04.output, integration.case, "s8_output", sprintf("%s.output.s8.rds", PROJECT))
s.obj <- readRDS(path.to.input.s.obj)
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.width=14, fig.height=10}

#####----------------------------------------------------------------------#####
##### add VDJ information
#####----------------------------------------------------------------------#####
vdj.outputdir <- file.path(outdir, PROJECT, output.version, config.version, "VDJ_output")
all.vdj.files <- Sys.glob(file.path(vdj.outputdir, "annotated_contigs_clonaltype_*.csv"))
names(all.vdj.files) <- to_vec( for(item in basename(all.vdj.files)) str_replace(str_replace(item, "annotated_contigs_clonaltype_", ""), ".csv", ""))

all.vdj.files <- all.vdj.files[all.integration.case[[integration.case]]]

vdjdf <- data.frame()
for (i in seq(1, length(all.vdj.files))){
  file <- all.vdj.files[[i]]
  tmpdf <- read.csv(file)
  vdjdf <- rbind(vdjdf, tmpdf)
}

vdjdf <- subset(vdjdf, select = -c(X, ID)) %>%
  rowwise() %>%
  mutate(barcode = str_replace(barcode, sprintf("%s_%s_", sample, sample), sprintf("%s_", sample)))

meta.data <- s.obj@meta.data %>% rownames_to_column("barcode")
meta.data <- merge(meta.data, vdjdf, by.x = "barcode", by.y = "barcode", all.x = TRUE) %>%
  rowwise() %>%
  mutate(with.clone = ifelse(is.na(CTstrict) == FALSE, "yes", "no")) %>%
  column_to_rownames("barcode")
meta.data <- meta.data[row.names(s.obj@meta.data), ]

cols.to.add <- setdiff(colnames(vdjdf), c("barcode", "sample"))

for (col in c(cols.to.add, "with.clone")){
  s.obj <- AddMetaData(object = s.obj, metadata = meta.data[[col]], col.name = col)
}

with.clone.cells <- subset(s.obj@meta.data, s.obj@meta.data$with.clone == "yes") %>% row.names()
without.clone.cells <- subset(s.obj@meta.data, s.obj@meta.data$with.clone == "no") %>% row.names()

```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
count.clone.global <- table(s.obj$with.clone) %>% data.frame()
colnames(count.clone.global) <- c("with.Clone", "count")
count.clone.global %>% create_dt()
```

# UMAP

## Cells with proper clone information and cells without proper clone information
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, cells.highlight = list("with.Clone" = with.clone.cells, "without.Clone" = without.clone.cells), label = TRUE, label.size = 8, reduction = "INTE_UMAP")
```

## UMAP: All cells in all samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, label = TRUE, label.size = 8, reduction = "INTE_UMAP", label.box = TRUE)
```

## UMAP: all cells, grouped by samples
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
DimPlot(object = s.obj, label = TRUE, label.size = 8, reduction = "INTE_UMAP", label.box = TRUE, group.by = "name")
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}

```